<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Aurum Project - Portafolio</title>
  <link rel="stylesheet" href="/client/css/style.css">

  <!-- Control de acceso: sólo clientes -->
  <script>
    const sesion = localStorage.getItem('sesionIniciada');
    const rol    = localStorage.getItem('rol');
    if (sesion !== 'true' || rol !== 'cliente') {
      window.location.href = '/';
    }
    document.addEventListener('DOMContentLoaded', () => {
      const gestorLink = document.querySelector('nav a[href="/gestor/dashboard.html"]');
      if (gestorLink) gestorLink.style.display = 'none';
    });
  </script>

  <style>
    .portfolio-section { max-width: 800px; margin: 2rem auto; padding: 1rem; background: #1a2640; border-radius: 8px; color: #fff; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    th, td { padding: 0.75rem; border: 1px solid #33415a; }
    th { background: #24324a; }
    td { background: #1f2b44; }
    #btnGenerarRenta, #btnAgregarActivo { background: #e67e22; color: #fff; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; margin: 0.5rem 0; }
    #btnGenerarRenta:hover, #btnAgregarActivo:hover { opacity: 0.9; }
    #rentaFormContainer { background: #24324a; padding: 1rem; border-radius: 6px; margin-top: 1rem; }
    #rentaForm .input-group { margin-bottom: 0.75rem; }
    #rentaForm label { display: block; font-weight: bold; margin-bottom: 0.25rem; }
    #rentaForm input { width: 100%; padding: 0.5rem; background: #1a2640; color: #fff; border: 1px solid #33415a; border-radius: 4px; }
    #rentaForm button { background: #27ae60; color: #fff; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; }
    #rentaForm button:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <nav>
    <h1>Portafolio de Activos</h1>
    <ul>
      <li><a href="/client/main.html">Inicio</a></li>
      <li><a href="/gestor/dashboard.html">Gestor</a></li>
      <li><a href="/client/logout.html">Cerrar Sesión</a></li>
    </ul>
  </nav>

  <main>
    <section class="portfolio-section">
      <h2>Mis Activos</h2>
      <button id="btnAgregarActivo">Agregar Nuevo Activo</button>
      <table id="portfolioTable">
        <thead>
          <tr>
            <th>Tipo de Activo</th>
            <th>Cantidad</th>
            <th>Precio unitario (€)</th>
            <th>Valor (€)</th>
          </tr>
        </thead>
        <tbody id="activoTable"></tbody>
      </table>

      <button id="btnGenerarRenta">Generar Info Declaración de la Renta</button>
      <div id="rentaFormContainer"></div>
    </section>
  </main>

  <div id="modalActivo" class="modal"> <!-- modal code aquí --> </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const portafolioId = +localStorage.getItem('portafolioId') || 0;
    if (!portafolioId) {
      alert('No se encuentra tu portafolio. Por favor, inicia sesión de nuevo.');
      return window.location.href = '/client/logout.html';
    }

    // Carga los activos del backend
    async function loadActivos() {
      const res = await fetch(`/api/portafolios/${portafolioId}/activos`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const activos = await res.json();
      const tbody = document.getElementById('activoTable');
      tbody.innerHTML = activos.map(a => {
        const nombre = a.nombre_activo || a.activo;
        const key    = nombre.toLowerCase();
        const qty    = parseFloat(a.cantidad).toFixed(8);
        return `
          <tr data-activo="${key}">
            <td>${nombre}</td>
            <td class="qty">${qty}</td>
            <td class="unit-price">–</td>
            <td class="value">–</td>
          </tr>`;
      }).join('');
    }

    // Actualiza precios y valores para cada fila según activo
    async function updateValores() {
      const rows = document.querySelectorAll('#activoTable tr');
      for (const row of rows) {
        const activo = row.dataset.activo;
        let price = 0;
        try {
          if (activo === 'bitcoin') {
            const res = await fetch('/api/crypto/price?activo=bitcoin');
            const data = await res.json();
            price = parseFloat(data.precio);
          } else if (activo === 'oro') {
            const res = await fetch('/api/metals/price?metal=oro');
            const data = await res.json();
            price = parseFloat(data.precio);
          } else {
            // Fiat o resto, se considera 1:1 con EUR
            price = 1;
          }
        } catch (err) {
          console.error(`Error al obtener precio de ${activo}:`, err);
          price = 0;
        }
        const qty = parseFloat(row.querySelector('.qty').textContent) || 0;
        row.querySelector('.unit-price').textContent = price ? price.toFixed(2) : '–';
        const val = price * qty;
        row.querySelector('.value').textContent = price ? val.toFixed(2) : '–';
      }
    }

    // Inicializa carga y actualizaciones periódicas
    loadActivos().then(() => {
      updateValores();
      setInterval(updateValores, 20000);
    }).catch(err => {
      console.error('Error cargando activos:', err);
      alert('No se pudo cargar los activos.');
    });

    // Generar formulario de renta
    document.getElementById('btnGenerarRenta').addEventListener('click', () => {
      const rows = document.querySelectorAll('#activoTable tr');
      let html = '<h3>Formulario Declaración de la Renta (Ficticio)</h3><form id="rentaForm">';
      rows.forEach(r => {
        const nombre = r.cells[0].textContent;
        const val    = r.cells[3].textContent;
        html += `<div class="input-group"><label>${nombre} - Valor (€)</label><input type="number" name="${nombre}" value="${val}" readonly></div>`;
      });
      html += '<button type="submit">Imprimir Formulario</button></form>';
      document.getElementById('rentaFormContainer').innerHTML = html;
      document.getElementById('rentaForm').addEventListener('submit', e => { e.preventDefault(); window.print(); });
    });
  });
  </script>

  <script src="/client/js/script.js"></script>
  <script src="/client/js/operaciones.js"></script>
</body>
</html>
