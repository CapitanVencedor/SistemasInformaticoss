<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aurum Project - Plataforma de Inversi√≥n</title>

  <!-- Fuentes -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" />

  <!-- Tu CSS externo -->
  <link rel="stylesheet" href="/client/css/style.css" />
  <link rel="stylesheet" href="/client/css/cliente.css" />

  <!-- Control de acceso: s√≥lo clientes -->
  <script>
    const sesion = localStorage.getItem('sesionIniciada');
    const rol    = localStorage.getItem('rol');
    if (sesion !== 'true' || rol !== 'cliente') {
      alert('Acceso restringido. Solo para clientes.');
      window.location.href = '/';
    }
  </script>

  <!-- Tus estilos en l√≠nea -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(180deg, #0f1c2e 0%, #13294b 100%);
      color: #fff;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <header>
    <h1>Aurum Client</h1>
    <nav>
      <a href="/client/main.html">Inicio</a>
      <a href="/client/portfolio.html">Portfolio</a>
      <a href="/client/historial.html">Historial</a> 
      <a href="/client/crypto_chart.html">Criptos</a>
      <a href="/client/oro_chart.html">Metales</a>
      <a href="/client/phantom_wallet.html">Phantom</a>
      <a href="/client/foro.html">Foro</a>
       <a href="/client/borrado.html" style="color: #e74c3c;">Eliminar cuenta</a>
      <a href="/client/logout.html">Cerrar Sesi√≥n</a>
    </nav>
  </header>

  <section class="hero">
    <h2>Invierte en Criptomonedas y Metales Preciosos</h2>
    <p>Bienvenido a la plataforma de compraventa de criptomonedas, oro y plata. Tecnolog√≠a, seguridad y transparencia en tus inversiones.</p>
  </section>

  <!-- NUEVA SECCI√ìN DE OPERACIONES -->
  <section class="operaciones" style="padding: 3rem 2rem; text-align: center; background-color: #121a27;">
    <h2 style="margin-bottom: 1rem;">Opera con tus activos</h2>


    <!-- Comprar -->
    <form id="formComprarMain" style="margin-bottom:2rem;">
      <h3 style="color:gold">Comprar</h3>
      <select id="comprarActivoMain" required>
        <option value="1">Bitcoin</option>
        <option value="2">Oro</option>
        <option value="3">Fiat</option>
      </select>
      <input id="comprarCantidadMain" type="number" step="any" placeholder="Cantidad" required />
      <input id="comprarValorMain"    type="number" step="any" placeholder="Total (‚Ç¨)" readonly />
      <button type="submit">Comprar</button>
    </form>

    <!-- Vender -->
    <form id="formVenderMain" style="margin-bottom:2rem;">
      <h3 style="color:gold">Vender</h3>
      <select id="venderActivoMain" required>
        <option value="1">Bitcoin</option>
        <option value="2">Oro</option>
        <option value="3">Fiat</option>
      </select>
      <input id="venderCantidadMain" type="number" step="any" placeholder="Cantidad" required />
      <input id="venderValorMain"    type="number" step="any" placeholder="Total (‚Ç¨)" readonly />
      <button type="submit">Vender</button>
    </form>

    <!-- Swap -->
    <form id="formSwapMain">
      <h3 style="color:gold">Swap</h3>
      <label>De:</label>
      <select id="swapDe" required>
        <option value="1">Bitcoin</option>
        <option value="2">Oro</option>
        <option value="3">Fiat</option>
      </select>
      <label>A:</label>
      <select id="swapA" required>
        <option value="1">Bitcoin</option>
        <option value="2">Oro</option>
        <option value="3">Fiat</option>
      </select>
      <input id="swapCantidad" type="number" step="any" placeholder="Cantidad" required />
      <input id="swapValor"    type="number" step="any" placeholder="Resultado" readonly />
      <button type="submit">Swapear</button>
    </form>

  <section class="features">
    <div class="feature">
      <h3>Criptomonedas</h3>
      <p>Compra y vende Bitcoin, Ethereum y m√°s de 50 activos digitales al instante.</p>
    </div>
    <div class="feature">
      <h3>Oro & Plata</h3>
      <p>Inversi√≥n en metales f√≠sicos y digitales con respaldo real y seguro.</p>
    </div>
    <div class="feature">
      <h3>Seguridad</h3>
      <p>Protecci√≥n avanzada de datos, cifrado de extremo a extremo y custodia en fr√≠o.</p>
    </div>
  </section>

  <section class="gallery" id="portfolio">
    <h2>Galer√≠a de Activos</h2>
    <div class="gallery-container">
      <div>
        <a href="/client/oro_chart.html">
          <img src="/client/img/oro.jpg" alt="Lingote de oro" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" />
        </a>
      </div>
      <div>
        <a href="/client/crypto_chart.html">
          <img src="/client/img/btc.png" alt="Bitcoin" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" />
        </a>
      </div>
      <div>
        <img src="/client/img/voxel.png" alt="Ethereum" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" />
      </div>
      <div>
        <img src="/client/img/plata.png" alt="Lingotes de plata" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" />
      </div>
    </div>
  </section>

  <section class="forum-preview" id="foro">
    <h2>√öltimos temas del foro</h2>
    <div class="post">
      <h4>[An√°lisis] ¬øSubir√° el BTC en junio?</h4>
      <p>Debate entre analistas sobre si se romper√° la resistencia de los 85k ‚Ç¨.</p>
    </div>
    <div class="post">
      <h4>[Consulta] Diferencia entre oro digital y f√≠sico</h4>
      <p>Un usuario pregunta sobre los beneficios fiscales y de custodia de cada tipo.</p>
    </div>
    <div class="post">
      <h4>[Alerta] Estafas recientes en plataformas P2P</h4>
      <p>Compa√±era informa sobre sitios fraudulentos de compraventa. Comparte tu experiencia.</p>
    </div>
  </section>

  <footer>
    <p>&copy; 2025 Aurum Project - Cliente | Dise√±o moderno, seguridad real.</p>
  </footer>


  <!-- SCRIPT DE COMPRA CORREGIDO -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const portafolioId = +localStorage.getItem('portafolioId') || 0;

  // Refs de DOM
  const sComp = document.getElementById('comprarActivoMain');
  const cComp = document.getElementById('comprarCantidadMain');
  const vComp = document.getElementById('comprarValorMain');
  const fComp = document.getElementById('formComprarMain');

  const sVend = document.getElementById('venderActivoMain');
  const cVend = document.getElementById('venderCantidadMain');
  const vVend = document.getElementById('venderValorMain');
  const fVend = document.getElementById('formVenderMain');

  const sDe   = document.getElementById('swapDe');
  const sSw   = document.getElementById('swapA'); 
  const cSw   = document.getElementById('swapCantidad');
  const vSw   = document.getElementById('swapValor');
  const fSw   = document.getElementById('formSwapMain');

  // Mapa ID ‚Üí clave
  const mapActivo = {1:'bitcoin', 2:'oro', 3:'fiat'};

  // Pide precio unitario seg√∫n activo
  async function fetchPrecioUnitario(idNum) {
    const key = mapActivo[idNum];
    if (key === 'fiat') return 1;
    const url = key === 'bitcoin'
      ? '/api/crypto/price?activo=bitcoin'
      : '/api/metals/price?metal=oro';
    const res = await fetch(url);
    if (!res.ok) throw new Error('Precio no disponible');
    const { precio } = await res.json();
    return precio;
  }

  // Recalcula un campo total = unitario √ó cantidad
  async function recTotal(sel, inpQ, inpT) {
  const q = parseFloat(inpQ.value);
  inpT.value = '';
  console.log('üëâ Cantidad:', q, 'Activo ID:', sel.value);
  if (!q) return;
  try {
    const unit = await fetchPrecioUnitario(+sel.value);
    console.log('üí∞ Precio unitario:', unit);
    inpT.value = (unit * q).toFixed(2);
  } catch (err) {
    console.error('‚ùå Error al calcular total:', err);
    inpT.value = '';
  }
}


  // Eventos compra
  sComp.addEventListener('change', () => recTotal(sComp, cComp, vComp));
  cComp.addEventListener('input', () => recTotal(sComp, cComp, vComp));

  // Eventos venta (igual l√≥gica)
  sVend.addEventListener('change', () => recTotal(sVend, cVend, vVend));
  cVend.addEventListener('input', () => recTotal(sVend, cVend, vVend));

  // Recalcula swap: (‚Ç¨/De * qty) / ‚Ç¨/A
  async function recSwap() {
    const q = parseFloat(cSw.value);
    vSw.value = '';
    if (!q || sDe.value === sSw.value) return;
    try {
      const pD = await fetchPrecioUnitario(+sDe.value);
      const pA = await fetchPrecioUnitario(+sSw.value);
      vSw.value = ((pD * q) / pA).toFixed(6);
    } catch {
      vSw.value = '';
    }
  }

  document.getElementById('swapA').addEventListener('change', recSwap);
  sDe.addEventListener('change', recSwap);
  cSw.addEventListener('input', recSwap);
  sSw.addEventListener('change', recSwap);

  // Helper POST
  async function postTx(path, body) {
    const res = await fetch(path, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || data.mensaje);
  }

  // Submit compra
  fComp.addEventListener('submit', async e => {
    e.preventDefault();
    const idn = +sComp.value;
    const q   = parseFloat(cComp.value);
    const t   = parseFloat(vComp.value);
    if (!q || !t) return alert('Introduce una cantidad v√°lida.');
    try {
      await postTx('/api/transacciones/comprar', {
        portafolio_id: portafolioId,
        activo_id:     idn,
        cantidad:      q,
        precio:        t / q,
        ip_origen:     location.hostname
      });
      alert('‚úÖ Compra realizada');
      window.location.reload();
    } catch (err) {
      alert(err.message);
    }
  });

  // Submit venta
  fVend.addEventListener('submit', async e => {
    e.preventDefault();
    const idn = +sVend.value;
    const q   = parseFloat(cVend.value);
    const t   = parseFloat(vVend.value);
    if (!q || !t) return alert('Introduce una cantidad v√°lida.');
    try {
      await postTx('/api/transacciones/vender', {
        portafolio_id: portafolioId,
        activo_id:     idn,
        cantidad:      q,
        precio:        t / q,
        ip_origen:     location.hostname
      });
      await postTx('/api/transacciones/comprar', {
        portafolio_id: portafolioId,
        activo_id:     3,
        cantidad:      t,
        precio:        1,
        ip_origen:     location.hostname
      });
      alert('‚úÖ Venta y saldo FIAT actualizado');
      window.location.reload();
    } catch (err) {
      alert(err.message);
    }
  });

// Submit swap CORREGIDO (main.html)
fSw.addEventListener('submit', async e => {
  e.preventDefault();

  const activo_origen_id = +sDe.value;
  const activo_destino_id = +document.getElementById('swapA').value;
  const cantidad_origen = parseFloat(cSw.value);
  const cantidad_destino = parseFloat(vSw.value); // resultado ya calculado

  if (!cantidad_origen || !cantidad_destino) 
    return alert('Introduce una cantidad v√°lida para swap.');

  try {
    await postTx('/api/transacciones/swap', {
      portafolio_id: portafolioId,
      activo_origen_id,
      activo_destino_id,
      cantidad: cantidad_origen,
      precio: cantidad_destino / cantidad_origen,
      ip_origen: location.hostname
    });

    alert('‚úÖ Swap completado');
    window.location.reload();
  } catch (err) {
    alert(err.message);
  }
});
});

</script>
<script src="/js/script.js"></script>
 <script src="/client/js/alertas_btc.js"></script>
 <script src="/client/js/alertas.js"></script>
</body>
</html>