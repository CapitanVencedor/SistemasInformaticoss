<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aurum Project - Plataforma de Inversión</title>

  <!-- Fuentes -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" />

  <!-- Tu CSS externo -->
  <link rel="stylesheet" href="/client/css/style.css" />
  <link rel="stylesheet" href="/client/css/cliente.css" />

  <!-- Control de acceso: sólo clientes -->
  <script>
    const sesion = localStorage.getItem('sesionIniciada');
    const rol    = localStorage.getItem('rol');
    if (sesion !== 'true' || rol !== 'cliente') {
      alert('Acceso restringido. Solo para clientes.');
      window.location.href = '/';
    }
  </script>

  <!-- Tus estilos en línea -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(180deg, #0f1c2e 0%, #13294b 100%);
      color: #fff;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <header>
    <h1>Aurum Client</h1>
    <nav>
      <a href="/client/main.html">Inicio</a>
      <a href="/client/portfolio.html">Portfolio</a>
      <a href="/client/crypto_chart.html">Criptos</a>
      <a href="/client/oro_chart.html">Metales</a>
      <a href="/client/phantom_wallet.html">Phantom</a>
      <a href="/client/foro.html">Foro</a>
      <a href="/client/logout.html">Cerrar Sesión</a>
    </nav>
  </header>

  <section class="hero">
    <h2>Invierte en Criptomonedas y Metales Preciosos</h2>
    <p>Bienvenido a la plataforma de compraventa de criptomonedas, oro y plata. Tecnología, seguridad y transparencia en tus inversiones.</p>
  </section>

  <!-- NUEVA SECCIÓN DE OPERACIONES -->
  <section class="operaciones" style="padding: 3rem 2rem; text-align: center; background-color: #121a27;">
    <h2 style="margin-bottom: 1rem;">Opera con tus activos</h2>

    <!-- Comprar -->
    <form id="formComprarMain" style="margin-bottom: 2rem;">
      <h3 style="color: gold;">Comprar</h3>
      <select id="comprarActivoMain" required>
        <option value="1">Bitcoin</option>
        <option value="2">Oro</option>
        <option value="3">Fiat</option>
      </select>
      <input type="number" id="comprarCantidadMain" step="any" placeholder="Cantidad" required />
      <input type="number" id="comprarValorMain" step="any" placeholder="Valor unitario" readonly />
      <button type="submit">Comprar</button>
    </form>

    <!-- Vender -->
    <form id="formVenderMain" style="margin-bottom: 2rem;">
      <h3 style="color: gold;">Vender</h3>
      <select id="venderActivoMain" required>
        <option value="1">Bitcoin</option>
        <option value="2">Oro</option>
        <option value="3">Fiat</option>
      </select>
      <input type="number" id="venderCantidadMain" step="any" placeholder="Cantidad" required />
      <input type="number" id="venderValorMain" step="any" placeholder="Valor unitario" required />
      <button type="submit">Vender</button>
    </form>

    <!-- Swap -->
    <form id="formSwapMain">
      <h3 style="color: gold;">Swap</h3>
      <label>De:</label>
      <select id="swapDe" required>
        <option value="1">Bitcoin</option>
        <option value="2">Oro</option>
        <option value="3">Fiat</option>
      </select>
      <label>A:</label>
      <select id="swapA" required>
        <option value="1">Bitcoin</option>
        <option value="2">Oro</option>
        <option value="3">Fiat</option>
      </select>
      <input type="number" id="swapCantidad" step="any" placeholder="Cantidad" required />
      <input type="number" id="swapValor" step="any" placeholder="Valor unitario (nuevo activo)" required />
      <button type="submit">Swapear</button>
    </form>
  </section>

  <section class="features">
    <div class="feature">
      <h3>Criptomonedas</h3>
      <p>Compra y vende Bitcoin, Ethereum y más de 50 activos digitales al instante.</p>
    </div>
    <div class="feature">
      <h3>Oro & Plata</h3>
      <p>Inversión en metales físicos y digitales con respaldo real y seguro.</p>
    </div>
    <div class="feature">
      <h3>Seguridad</h3>
      <p>Protección avanzada de datos, cifrado de extremo a extremo y custodia en frío.</p>
    </div>
  </section>

  <section class="gallery" id="portfolio">
    <h2>Galería de Activos</h2>
    <div class="gallery-container">
      <div>
        <a href="/client/oro_chart.html">
          <img src="/client/img/oro.jpg" alt="Lingote de oro" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" />
        </a>
      </div>
      <div>
        <a href="/client/crypto_chart.html">
          <img src="/client/img/btc.png" alt="Bitcoin" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" />
        </a>
      </div>
      <div>
        <img src="/client/img/voxel.png" alt="Ethereum" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" />
      </div>
      <div>
        <img src="/client/img/plata.png" alt="Lingotes de plata" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" />
      </div>
    </div>
  </section>

  <section class="forum-preview" id="foro">
    <h2>Últimos temas del foro</h2>
    <div class="post">
      <h4>[Análisis] ¿Subirá el BTC en junio?</h4>
      <p>Debate entre analistas sobre si se romperá la resistencia de los 85k €.</p>
    </div>
    <div class="post">
      <h4>[Consulta] Diferencia entre oro digital y físico</h4>
      <p>Un usuario pregunta sobre los beneficios fiscales y de custodia de cada tipo.</p>
    </div>
    <div class="post">
      <h4>[Alerta] Estafas recientes en plataformas P2P</h4>
      <p>Compañera informa sobre sitios fraudulentos de compraventa. Comparte tu experiencia.</p>
    </div>
  </section>

  <footer>
    <p>&copy; 2025 Aurum Project - Cliente | Diseño moderno, seguridad real.</p>
  </footer>

  <!-- Ajuste URL alertas_btc.js -->
  <script src="/client/js/alertas_btc.js"></script>

  <!-- SCRIPT DE COMPRA CORREGIDO -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // 1) Obtén usuario y portafolioId
      const rawUser = localStorage.getItem('usuario');
      console.log('DEBUG localStorage usuario:', rawUser);
      const user = rawUser ? JSON.parse(rawUser) : null;
      let portafolioId = user ? user.portafolioId : null;

      //  Si no existe en user, obtenlo vía API
      if (!portafolioId && user) {
        try {
          const res = await fetch('/api/portafolios');
          const lista = await res.json();
          const miPort = lista.find(p => p.usuario_id === user.id);
          portafolioId = miPort ? miPort.id : null;
          console.log('DEBUG portafolioId from API:', portafolioId);
        } catch (e) {
          console.error('Error fetching portafolios:', e);
        }
      }

      if (!portafolioId) {
        alert('No se ha detectado tu portafolio. Por favor vuelve a iniciar sesión.');
        return window.location.href = '/';
      }

      // 2) Referencias DOM
      const selectComprar  = document.getElementById('comprarActivoMain');
      const inputCantidad  = document.getElementById('comprarCantidadMain');
      const inputValor     = document.getElementById('comprarValorMain');
      const formComprar    = document.getElementById('formComprarMain');

      // 3) Calcular valor unitario al vuelo
      inputCantidad.addEventListener('input', async () => {
        const qty = parseFloat(inputCantidad.value);
        if (!qty) { inputValor.value = ''; return; }
        try {
          const res = await fetch('/api/crypto/price');
          if (!res.ok) throw new Error('No hay precio');
          const { precio } = await res.json();
          inputValor.value = precio.toFixed(2);
        } catch (err) {
          console.error('Error al obtener precio:', err);
          inputValor.value = '';
        }
      });

      // 4) Enviar compra
      formComprar.addEventListener('submit', async e => {
        e.preventDefault();
        const activo_id = +selectComprar.value;
        const cantidad  = +inputCantidad.value;
        try {
          const resPrice = await fetch('/api/crypto/price');
          if (!resPrice.ok) throw new Error('No hay precio');
          const { precio } = await resPrice.json();

          const resTx = await fetch('/api/transacciones/comprar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ portafolio_id: portafolioId, activo_id, cantidad, precio, ip_origen: location.hostname })
          });
          const body = await resTx.json();
          if (!resTx.ok) throw new Error(body.error || 'Error en la compra');
          alert('Compra realizada con éxito');
          window.location.reload();
        } catch (err) {
          console.error('❌ Error en la compra:', err);
          alert('No se pudo completar la compra: ' + err.message);
        }
      });
    });
  </script>
</body>
</html>